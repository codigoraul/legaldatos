---
import Layout from '../layouts/Layout.astro';

const seo = {
	title: 'Contacto | LegalDatos - Asesoría en Protección de Datos',
	description: 'Contacta a LegalDatos para asesoría especializada en protección de datos personales y compliance bajo la Ley 21.719. Teléfono: +56 9 6843 4272. Ubicación: Huérfanos 757, Santiago.',
	keywords: 'contacto LegalDatos, asesoría protección de datos, consulta legal datos, teléfono abogado datos, contacto compliance Chile, formulario contacto, consultoría Ley 21.719, Santiago abogados',
	canonical: `${import.meta.env.BASE_URL}contacto/`,
	ogTitle: 'Contacto | LegalDatos - Expertos en Protección de Datos',
	ogDescription: 'Contacta a nuestros expertos en protección de datos personales. Asesoría legal especializada en Ley 21.719.',
	ogImage: `${import.meta.env.BASE_URL}logo-legaldatos.png`
};

const info = {
	email: 'contacto@legaldatos.cl',
	phone: '+56 9 68434272',
	address: 'Huérfanos 757, Oficina 614\nSantiago Centro',
	hours: 'Lunes a Viernes 9:00 - 18:00',
};

// Email para pruebas
const testEmail = 'codigoraul@mail.com';

const hero = {
	title: 'Contacto',
};
---

<Layout hero={hero} seo={seo}>
	<section class="section contact-body">
		<div class="container">
			<h1 class="page-title" style="padding-top: 28px; padding-bottom: 12px;">Canales de Contacto</h1>

			<div class="grid">
				<div>
					<h2 class="section-subtitle">Datos de contacto</h2>
					<div class="panel">
						<div class="items">
							<div class="item">
								<div class="k">Email</div>
								<a class="v link" href={`mailto:${info.email}`}>{info.email}</a>
							</div>
							<div class="item">
								<div class="k">Teléfono</div>
								<a class="v link" href={`tel:${info.phone.replace(/\s+/g, '')}`}>{info.phone}</a>
							</div>
							<div class="item">
								<div class="k">Dirección</div>
								<div class="v" style="white-space: pre-line;">{info.address}</div>
							</div>
							<div class="item">
								<div class="k">Horario</div>
								<div class="v">{info.hours}</div>
							</div>
						</div>

						<div class="meta">
							<div class="tag">Protección de datos</div>
							<div class="tag">Cumplimiento</div>
							<div class="tag">Ley 21.719</div>
						</div>
					</div>
				</div>

				<div>
					<h2 class="section-subtitle">Formulario de contacto</h2>
					<div class="panel">
						<form
							class="form"
							id="contactForm"
							action="/api/contacto"
							method="POST"
							novalidate
						>
							<div class="row">
								<label class="field">
									<span class="label">Nombre</span>
									<input 
										name="Nombre" 
										type="text" 
										required 
										minlength="2"
										maxlength="50"
										pattern="[A-Za-z\sáéíóúÁÉÍÓÚñÑ]+"
										placeholder="Tu nombre (mínimo 2 caracteres)"
										title="El nombre debe contener solo letras y tener al menos 2 caracteres"
									/>
								</label>
								<label class="field">
									<span class="label">Email</span>
									<input 
										name="Email" 
										type="email" 
										required 
										minlength="5"
										maxlength="100"
										placeholder="tu@correo.com"
										title="Ingresa un email válido"
									/>
								</label>
							</div>

							<label class="field">
								<span class="label">Asunto</span>
								<input 
									name="Asunto" 
									type="text" 
									required 
									minlength="3"
									maxlength="100"
									pattern="[A-Za-z0-9\sáéíóúÁÉÍÓÚñÑ.,?¿!¡]+"
									placeholder="Ej: Consulta por cumplimiento"
									title="El asunto debe tener entre 3 y 100 caracteres"
								/>
							</label>

							<label class="field">
								<span class="label">Mensaje</span>
								<textarea 
									name="Mensaje" 
									required 
									minlength="10"
									maxlength="1000"
									rows={7} 
									placeholder="Cuéntanos tu caso y contexto (empresa, industria, urgencia, etc.)"
									title="El mensaje debe tener entre 10 y 1000 caracteres"
								></textarea>
							</label>

							<div class="actions">
								<button class="submit-btn" type="submit">
									<span class="btn-text">Enviar Mensaje</span>
									<span class="btn-icon">→</span>
								</button>
								<p class="hint">Tu mensaje será enviado de forma segura a nuestros servidores.</p>
								
								<div id="formMessage" class="form-message"></div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</section>
</Layout>

<script>
	// Forzar limpieza de caché y ejecución inmediata
	(function() {
		'use strict';
		
		function handleFormSubmit() {
			const form = document.getElementById('contactForm');
			if (!form) {
				console.log('Formulario no encontrado');
				return;
			}
			
			console.log('Formulario encontrado, configurando handler');
			
			// Remover cualquier event listener anterior
			form.onsubmit = null;
			
			form.onsubmit = async function(e) {
				console.log('Submit interceptado');
				e.preventDefault();
				e.stopPropagation();
				
				const submitBtn = this.querySelector('.submit-btn');
				const messageDiv = document.getElementById('formMessage');
				
				if (!submitBtn || !messageDiv) {
					console.log('Botón o message div no encontrado');
					return;
				}
				
				const originalText = submitBtn.innerHTML;
				
				// Loading state
				submitBtn.disabled = true;
				submitBtn.innerHTML = '<span class="btn-text">Enviando...</span><span class="btn-icon">⏳</span>';
				messageDiv.innerHTML = '';
				messageDiv.className = 'form-message';
				
				try {
					const formData = new FormData(this);
					console.log('Enviando datos...');
					
					const response = await fetch('/api/contacto', {
						method: 'POST',
						body: formData,
						cache: 'no-cache'
					});
					
					const result = await response.json();
					console.log('Respuesta:', result);
					
					if (result.success) {
						messageDiv.innerHTML = '✅ Mensaje enviado correctamente. Te responderemos a la brevedad.';
						messageDiv.classList.add('success');
						this.reset();
					} else {
						messageDiv.innerHTML = `❌ Error: ${result.error}`;
						messageDiv.classList.add('error');
					}
				} catch (error) {
					console.error('Error:', error);
					messageDiv.innerHTML = '❌ Error de conexión. Por favor, intenta nuevamente.';
					messageDiv.classList.add('error');
				} finally {
					// Restaurar botón
					submitBtn.disabled = false;
					submitBtn.innerHTML = originalText;
				}
			};
		}
		
		// Ejecutar inmediatamente y también en DOMContentLoaded
		handleFormSubmit();
		
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', handleFormSubmit);
		}
	})();
</script>

<style>
	.page-subtitle {
		margin: 10px auto 0;
		max-width: 70ch;
		color: var(--muted);
		font-size: 16px;
		line-height: 1.7;
	}

	.contact-body {
		padding-top: 28px;
		padding-bottom: 72px;
		background: #f8fafc;
	}

	.grid {
		display: grid;
		grid-template-columns: 0.95fr 1.05fr;
		gap: 18px;
		align-items: start;
	}

	.panel {
		background: rgba(255, 255, 255, 0.95);
		border: 1px solid rgba(15, 23, 42, 0.10);
		border-radius: 16px;
		box-shadow: 0 4px 20px rgba(2, 6, 23, 0.06);
		padding: 24px;
	}

	.panel-title {
		margin: 0 0 14px;
		font-size: 14px;
		letter-spacing: 0.08em;
		text-transform: uppercase;
		color: rgba(42, 55, 85, 0.92);
	}

	.section-subtitle {
		margin: 0 0 24px;
		font-size: 22px;
		font-weight: 700;
		color: var(--primary);
		letter-spacing: -0.01em;
	}

	.items {
		display: grid;
		gap: 12px;
	}

	.item {
		padding: 16px 18px;
		border-radius: 12px;
		background: rgba(247, 249, 252, 0.9);
		border: 1px solid rgba(15, 23, 42, 0.08);
	}

	.k {
		font-size: 12px;
		text-transform: uppercase;
		letter-spacing: 0.08em;
		color: rgba(15, 23, 42, 0.6);
		font-weight: 700;
		margin-bottom: 6px;
	}

	.v {
		font-size: 16px;
		color: rgba(15, 23, 42, 0.9);
		font-weight: 650;
		line-height: 1.6;
	}

	.meta {
		margin-top: 16px;
		display: flex;
		gap: 8px;
		flex-wrap: wrap;
	}

	.tag {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		padding: 8px 10px;
		border-radius: 999px;
		background: rgba(34, 211, 238, 0.10);
		border: 1px solid rgba(34, 211, 238, 0.20);
		color: rgba(42, 55, 85, 0.92);
		font-weight: 750;
		font-size: 12px;
		letter-spacing: 0.02em;
	}

	.form {
		display: grid;
		gap: 12px;
	}

	.row {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 12px;
	}

	.field {
		display: grid;
		gap: 8px;
	}

	.label {
		font-size: 12px;
		text-transform: uppercase;
		letter-spacing: 0.08em;
		color: rgba(15, 23, 42, 0.6);
		font-weight: 800;
	}

	input,
	textarea {
		border-radius: 16px;
		border: 1px solid rgba(15, 23, 42, 0.10);
		background: rgba(255, 255, 255, 0.9);
		backdrop-filter: blur(8px);
		padding: 16px 16px;
		font-size: 16px;
		font-weight: 600;
		color: rgba(15, 23, 42, 0.92);
		outline: none;
		transition: all 0.3s ease;
		position: relative;
	}

	input::placeholder,
	textarea::placeholder {
		color: rgba(15, 23, 42, 0.4);
		font-weight: 500;
	}

	textarea {
		resize: vertical;
		min-height: 140px;
	}

	input:focus,
	textarea:focus {
		border-color: rgba(34, 211, 238, 0.55);
		box-shadow: 
			0 0 0 4px rgba(34, 211, 238, 0.12),
			0 0 20px rgba(34, 211, 238, 0.15);
		background: rgba(255, 255, 255, 0.98);
		transform: translateY(-2px);
	}

	.actions {
		display: flex;
		gap: 12px;
		align-items: center;
		justify-content: space-between;
		flex-wrap: wrap;
		margin-top: 4px;
	}

	.hint {
		margin: 0;
		color: var(--muted);
		font-size: 14px;
		line-height: 1.5;
	}

	.form-message {
		margin-top: 16px;
		padding: 12px 16px;
		border-radius: 8px;
		font-size: 14px;
		font-weight: 500;
		line-height: 1.4;
	}

	.form-message.success {
		background: rgba(34, 197, 94, 0.1);
		border: 1px solid rgba(34, 197, 94, 0.3);
		color: #16a34a;
	}

	.form-message.error {
		background: rgba(239, 68, 68, 0.1);
		border: 1px solid rgba(239, 68, 68, 0.3);
		color: #dc2626;
	}

	.submit-btn {
		display: inline-flex;
		align-items: center;
		gap: 12px;
		padding: 16px 32px;
		border: none;
		border-radius: 16px;
		background: linear-gradient(135deg, var(--accent), #7c3aed);
		color: white;
		font-size: 16px;
		font-weight: 700;
		text-decoration: none;
		cursor: pointer;
		transition: all 0.3s ease;
		position: relative;
		overflow: hidden;
		box-shadow: 
			0 8px 24px rgba(34, 211, 238, 0.3),
			0 0 0 1px rgba(255, 255, 255, 0.1) inset;
	}

	.submit-btn::before {
		content: '';
		position: absolute;
		top: 0;
		left: -100%;
		width: 100%;
		height: 100%;
		background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
		transition: left 0.6s ease;
	}

	.submit-btn:hover {
		transform: translateY(-2px);
		box-shadow: 
			0 12px 32px rgba(34, 211, 238, 0.4),
			0 0 0 1px rgba(255, 255, 255, 0.2) inset;
	}

	.submit-btn:hover::before {
		left: 100%;
	}

	.submit-btn:active {
		transform: translateY(0);
	}

	.btn-text {
		position: relative;
		z-index: 1;
	}

	.btn-icon {
		font-size: 18px;
		transition: transform 0.3s ease;
		position: relative;
		z-index: 1;
	}

	.submit-btn:hover .btn-icon {
		transform: translateX(4px);
	}

	@media (max-width: 980px) {
		.grid {
			grid-template-columns: 1fr;
		}
	}

	@media (max-width: 720px) {
		.page-intro {
			margin: 8px auto 18px;
		}
		.page-title {
			font-size: 28px;
		}
		.page-subtitle {
			font-size: 15px;
		}

		.panel {
			padding: 18px;
		}

		.row {
			grid-template-columns: 1fr;
		}
	}
</script>
