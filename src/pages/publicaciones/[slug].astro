---
import Layout from '../../layouts/Layout.astro';

type Post = {
	id: number;
	slug: string;
	title: { rendered: string };
	content: { rendered: string };
	date?: string;
	_embedded?: {
		author?: Array<{ name?: string }>;
		['wp:featuredmedia']?: Array<{ source_url?: string; alt_text?: string }>;
	};
};

export async function getStaticPaths() {
	const WP_BASE = import.meta.env.PUBLIC_WP_URL ?? 'http://localhost:10189';

	// Si no estamos en producción o no hay WP_URL, retornar rutas vacías
	if (!WP_BASE || WP_BASE === 'http://localhost:10189') {
		return [];
	}

	try {
		let posts: Post[] = [];
		const perPage = 100;
		let page = 1;
		let totalPages = 1;

		while (page <= totalPages) {
			const res = await fetch(`${WP_BASE}/wp-json/wp/v2/posts?_embed&per_page=${perPage}&page=${page}`, {
				headers: { Accept: 'application/json' },
			});
			if (!res.ok) {
				throw new Error(`WP ${res.status}`);
			}
			const headerTotalPages = Number(res.headers.get('x-wp-totalpages') ?? '1');
			totalPages = Number.isFinite(headerTotalPages) && headerTotalPages > 0 ? headerTotalPages : 1;

			const batch = (await res.json()) as Post[];
			posts = posts.concat(batch);
			page += 1;
		}

		return posts.map((post) => ({
			params: { slug: post.slug },
		}));
	} catch (error) {
		console.warn('No se pudo conectar a WordPress, generando rutas vacías:', error);
		return [];
	}
}

const { slug } = Astro.params as { slug: string };
---

<Layout>
	<meta http-equiv="refresh" content={`0; url=/articulos/${slug}`} />
</Layout>
